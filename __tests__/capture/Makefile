# Makefile pour tester le module de capture audio
# Tests unitaires complets pour les classes Audio Capture

CXX = g++
CXXFLAGS = -std=c++20 -Wall -Wextra -I.
TARGET = test_capture_audio
SOURCE = test_capture_audio.cpp

.PHONY: all clean test help

all: test

help:
	@echo "ğŸµ TESTS UNITAIRES - MODULE CAPTURE AUDIO"
	@echo "========================================"
	@echo "Commandes disponibles:"
	@echo "  make test    - ExÃ©cuter tous les tests"
	@echo "  make clean   - Nettoyer les fichiers temporaires"
	@echo "  make help    - Afficher cette aide"

test: $(TARGET)
	@echo ""
	@echo "ğŸš€ EXÃ‰CUTION DES TESTS:"
	@echo "======================"
	@echo ""
	@echo "ğŸµ Testing Audio Capture Module..."
	@./$(TARGET) && echo "" && echo "ğŸ‰ ALL TESTS PASSED!" || echo "" && echo "ğŸ’¥ SOME TESTS FAILED!"
	@echo ""
	@echo "ğŸ“Š VALIDATION RÃ‰SUMÃ‰:"
	@echo "   ğŸ”„ AudioFormatConverter : 5 tests"
	@echo "   ğŸ“Š CircularBuffer       : 6 tests"
	@echo "   ğŸ“ˆ AudioAnalyzer        : 8 tests"
	@echo "   ğŸ“ AudioFileWriter       : 3 tests"
	@echo "   â±ï¸  AudioTimer           : 3 tests"
	@echo "   ğŸŠ AudioBufferPool       : 3 tests"
	@echo "   ğŸ“ˆ TOTAL                : 28 tests !"
	@echo ""

$(TARGET): $(SOURCE)
	@echo "ğŸ”¨ Compiling Audio Capture Test..."
	@$(CXX) $(CXXFLAGS) -o $@ $<

clean:
	@echo "ğŸ§¹ Cleaning up..."
	@rm -f $(TARGET)
	@rm -f test_output.wav
	@echo "âœ… Clean complete"

# Tests de compilation uniquement (sans exÃ©cution)
compile-only:
	@echo "ğŸ”¨ Testing compilation only..."
	@$(CXX) $(CXXFLAGS) -c $(SOURCE) && echo "âœ… Compilation OK" || echo "âŒ Compilation failed"
	@rm -f *.o

# Test avec diffÃ©rents niveaux d'optimisation
test-optimized:
	@echo "âš¡ Testing with optimization..."
	@$(CXX) $(CXXFLAGS) -O2 -DNDEBUG -o $(TARGET)_opt $(SOURCE)
	@./$(TARGET)_opt && echo "âœ… Optimized version OK"
	@rm -f $(TARGET)_opt

# Test de compatibilitÃ© C++17 (fallback)
test-cpp17:
	@echo "ğŸ”„ Testing C++17 compatibility..."
	@$(CXX) -std=c++17 $(CXXFLAGS) -o $(TARGET)_17 $(SOURCE) && echo "âœ… C++17 compatible" || echo "âš ï¸ C++17 incompatible"
	@rm -f $(TARGET)_17

# Test avec instrumentation pour valgrind
test-valgrind:
	@echo "ğŸ” Testing with valgrind (memory check)..."
	@if command -v valgrind >/dev/null 2>&1; then \
		$(CXX) $(CXXFLAGS) -g -o $(TARGET)_debug $(SOURCE) && \
		valgrind --leak-check=full --error-exitcode=1 ./$(TARGET)_debug && echo "âœ… No memory leaks detected" || echo "âŒ Memory issues found"; \
		rm -f $(TARGET)_debug; \
	else \
		echo "âš ï¸ Valgrind not installed, skipping memory test"; \
	fi

# Benchmark des performances
benchmark:
	@echo "ğŸ“Š Running performance benchmark..."
	@time ./$(TARGET) >/dev/null 2>&1 && echo "âœ… Performance test completed" || echo "âŒ Performance test failed"
